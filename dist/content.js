(()=>{var e=new Map,r=0;function t(){e.forEach((function(e){e.elements.forEach((function(e){if(e&&e.parentNode){var r=e.textContent,t=document.createTextNode(r);e.parentNode.replaceChild(t,e)}}))})),e.clear(),r=0}function n(e){return e.replace(/\s+/g," ").trim()}function o(t,o,a,i){var c,l=++r,s=a?t:n(t);try{c=function(e,r,t){if(r)return new RegExp(e,t?"g":"gi");var n=e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");return new RegExp(n,t?"g":"gi")}(s,a,i)}catch(e){return console.error("Invalid regex pattern:",e),{elements:[],error:"Invalid regex pattern"}}var h={id:l,text:s,color:o,elements:[]},d=document.createTreeWalker(document.body,NodeFilter.SHOW_TEXT,{acceptNode:function(e){var r,t=e.parentNode;return!t||"SCRIPT"===t.nodeName||"STYLE"===t.nodeName||"NOSCRIPT"===t.nodeName||null!==(r=t.classList)&&void 0!==r&&r.contains("page-highlighter-highlight")||t.isContentEditable?NodeFilter.FILTER_REJECT:NodeFilter.FILTER_ACCEPT}});try{for(var g,u=[];g=d.nextNode();)a||(g.nodeValue=n(g.nodeValue)),u.push(g);if(u.forEach((function(e){!function(e,r,t,n){var o=e.nodeValue,a=Array.from(o.matchAll(r));if(0===a.length)return!1;var i=document.createDocumentFragment(),c=0;a.forEach((function(e){e.index>c&&i.appendChild(document.createTextNode(o.substring(c,e.index)));var r=function(e,r){var t=document.createElement("span");return t.style.backgroundColor=r,t.className="page-highlighter-highlight",t.textContent=e,t}(e[0],t);i.appendChild(r),n.elements.push(r),c=e.index+e[0].length})),c<o.length&&i.appendChild(document.createTextNode(o.substring(c))),e.parentNode.replaceChild(i,e)}(e,c,o,h)})),h.elements.length>0){e.set(l,h);try{chrome.runtime.sendMessage({action:"highlight-added",highlight:{id:l,text:s,color:o,count:h.elements.length}})}catch(e){console.error("Failed to send highlight-added message:",e)}}}catch(e){return console.error("Error while highlighting:",e),{elements:[],error:e.message}}return h}chrome.runtime.onMessage.addListener((function(r,n,a){try{switch(r.action){case"ping":a({success:!0});break;case"highlight":t();var i=o(r.text,r.color,r.isRegex,r.isCaseSensitive);i.error?a({success:!1,error:i.error}):a({success:i.elements.length>0,count:i.elements.length});break;case"get-highlights":a({highlights:Array.from(e.values()).map((function(e){return{id:e.id,text:e.text,color:e.color}}))});break;case"remove-highlight":t(),a({success:!0});break;default:a({error:"Unknown action"})}}catch(e){console.error("Error in message handler:",e),a({error:e.message})}return!0}))})();