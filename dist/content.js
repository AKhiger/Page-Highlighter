(()=>{var e=new Map,t=0;function r(e){return e.replace(/\s+/g," ").trim()}function n(n,o,a,i){var c,l=++t,s=a?n:r(n);try{c=function(e,t,r){if(t)return new RegExp(e,r?"g":"gi");var n=e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");return new RegExp(n,r?"g":"gi")}(s,a,i)}catch(e){return console.error("Invalid regex pattern:",e),{elements:[],error:"Invalid regex pattern"}}var d={id:l,text:s,color:o,elements:[]},h=document.createTreeWalker(document.body,NodeFilter.SHOW_TEXT,{acceptNode:function(e){var t,r=e.parentNode;return!r||"SCRIPT"===r.nodeName||"STYLE"===r.nodeName||"NOSCRIPT"===r.nodeName||null!==(t=r.classList)&&void 0!==t&&t.contains("page-highlighter-highlight")||r.isContentEditable?NodeFilter.FILTER_REJECT:NodeFilter.FILTER_ACCEPT}});try{for(var g,u=[];g=h.nextNode();)a||(g.nodeValue=r(g.nodeValue)),u.push(g);if(u.forEach((function(e){!function(e,t,r,n){var o=e.nodeValue,a=Array.from(o.matchAll(t));if(0===a.length)return!1;var i=document.createDocumentFragment(),c=0;a.forEach((function(e){e.index>c&&i.appendChild(document.createTextNode(o.substring(c,e.index)));var t=function(e,t){var r=document.createElement("span");return r.style.backgroundColor=t,r.className="page-highlighter-highlight",r.textContent=e,r}(e[0],r);i.appendChild(t),n.elements.push(t),c=e.index+e[0].length})),c<o.length&&i.appendChild(document.createTextNode(o.substring(c))),e.parentNode.replaceChild(i,e)}(e,c,o,d)})),d.elements.length>0){e.set(l,d);try{chrome.runtime.sendMessage({action:"highlight-added",highlight:{id:l,text:s,color:o,count:d.elements.length}})}catch(e){console.error("Failed to send highlight-added message:",e)}}}catch(e){return console.error("Error while highlighting:",e),{elements:[],error:e.message}}return d}chrome.runtime.onMessage.addListener((function(r,o,a){try{switch(r.action){case"ping":a({success:!0});break;case"highlight":e.forEach((function(e){e.elements.forEach((function(e){if(e&&e.parentNode){var t=e.textContent,r=document.createTextNode(t);e.parentNode.replaceChild(r,e)}}))})),e.clear(),t=0;var i=n(r.text,r.color,r.isRegex,r.isCaseSensitive);i.error?a({success:!1,error:i.error}):a({success:i.elements.length>0,count:i.elements.length});break;case"get-highlights":a({highlights:Array.from(e.values()).map((function(e){return{id:e.id,text:e.text,color:e.color}}))});break;case"remove-highlight":!function(t){var r=e.get(t);r&&(r.elements.forEach((function(e){if(e&&e.parentNode){var t=e.textContent,r=document.createTextNode(t);e.parentNode.replaceChild(r,e)}})),e.delete(t))}(r.id),a({success:!0});break;default:a({error:"Unknown action"})}}catch(e){console.error("Error in message handler:",e),a({error:e.message})}return!0}))})();
