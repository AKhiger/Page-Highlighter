(()=>{var e=new Map,t=0;function n(e){return e.parentNode&&e.parentNode.normalize(),e}function r(e){if(!e||!e.parentNode)return null;var t=e.textContent,r=e.previousSibling,o=e.nextSibling,i=document.createTextNode(t);return!r||r.nodeType!==Node.TEXT_NODE||r.textContent.endsWith(" ")||t.startsWith(" ")||e.parentNode.insertBefore(document.createTextNode(" "),e),e.parentNode.replaceChild(i,e),!o||o.nodeType!==Node.TEXT_NODE||o.textContent.startsWith(" ")||t.endsWith(" ")||e.parentNode.insertBefore(document.createTextNode(" "),o),n(i.parentNode),i}function o(e){return e.replace(/\s+/g," ").trim()}function i(r,i,a,c){var s,d=++t,l=a?r:o(r);try{s=function(e,t,n){if(t)return new RegExp(e,n?"g":"gi");var r=e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");return new RegExp(r,n?"g":"gi")}(l,a,c)}catch(e){return console.error("Invalid regex pattern:",e),{elements:[],error:"Invalid regex pattern"}}var h={id:d,text:l,color:i,elements:[]},g=document.createTreeWalker(document.body,NodeFilter.SHOW_TEXT,{acceptNode:function(e){var t,n=e.parentNode;return!n||"SCRIPT"===n.nodeName||"STYLE"===n.nodeName||"NOSCRIPT"===n.nodeName||null!==(t=n.classList)&&void 0!==t&&t.contains("page-highlighter-highlight")||n.isContentEditable?NodeFilter.FILTER_REJECT:NodeFilter.FILTER_ACCEPT}});try{for(var u,m=[];u=g.nextNode();)m.push(u);if(m.forEach((function(e){!function(e,t,r,i){n(e.parentNode);var a=e.nodeValue,c=t.flags.includes("i")?a:o(a),s=Array.from(c.matchAll(t));if(0===s.length)return!1;var d=document.createDocumentFragment(),l=0;s.forEach((function(e){e.index>l&&d.appendChild(document.createTextNode(a.substring(l,e.index)));var t=function(e,t){var n=document.createElement("span");return n.style.backgroundColor=t,n.className="page-highlighter-highlight",n.textContent=e,n}(a.substring(e.index,e.index+e[0].length),r);d.appendChild(t),i.elements.push(t),l=e.index+e[0].length})),l<a.length&&d.appendChild(document.createTextNode(a.substring(l))),e.parentNode.replaceChild(d,e)}(e,s,i,h)})),h.elements.length>0){e.set(d,h);try{chrome.runtime.sendMessage({action:"highlight-added",highlight:{id:d,text:l,color:i,count:h.elements.length}})}catch(e){console.error("Failed to send highlight-added message:",e)}}}catch(e){return console.error("Error while highlighting:",e),{elements:[],error:e.message}}return h}chrome.runtime.onMessage.addListener((function(o,a,c){try{switch(o.action){case"ping":c({success:!0});break;case"highlight":e.forEach((function(e){e.elements.forEach((function(e){r(e)}))})),n(document.body),e.clear(),t=0;var s=i(o.text,o.color,o.isRegex,o.isCaseSensitive);s.error?c({success:!1,error:s.error}):c({success:s.elements.length>0,count:s.elements.length});break;case"get-highlights":c({highlights:Array.from(e.values()).map((function(e){return{id:e.id,text:e.text,color:e.color}}))});break;case"remove-highlight":!function(t){var o=e.get(t);o&&(o.elements.forEach((function(e){r(e)})),n(document.body),e.delete(t))}(o.id),c({success:!0});break;default:c({error:"Unknown action"})}}catch(e){console.error("Error in message handler:",e),c({error:e.message})}return!0}))})();