(()=>{var e=new Map,t=new Map,n=0,r=null;function a(t){if(e.has(t)){var n=e.get(t),r=new Map;n.forEach((function(e){r.has(e.parent)||r.set(e.parent,e)})),r.forEach((function(e){var t=e.parent,n=e.originalHTML;t&&t.parentNode&&(t.innerHTML=n)})),e.delete(t)}}function o(){e.forEach((function(e,t){a(t)})),e.clear(),t.clear(),n=0,r=null}function i(o,i,c,s){var l,h=++n,g=c?o:function(e){return e.replace(/\s+/g," ").trim()}(o),d="".concat(g,"_").concat(c,"_").concat(s);r&&r!==d&&a(r),r=d;try{l=function(e,t,n){if(t)return new RegExp(e,n?"g":"gi");var r=e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");return new RegExp(r,n?"g":"gi")}(g,c,s)}catch(e){return console.error("Invalid regex pattern:",e),{elements:[],error:"Invalid regex pattern"}}var u={id:h,text:g,color:i,elements:[],searchPatternKey:d},m=document.createTreeWalker(document.body,NodeFilter.SHOW_TEXT,{acceptNode:function(e){var t,n,r,a=e.parentNode;return!a||"SCRIPT"===a.nodeName||"STYLE"===a.nodeName||"NOSCRIPT"===a.nodeName||null!==(t=a.classList)&&void 0!==t&&t.contains("page-highlighter-highlight")||null!==(n=a.classList)&&void 0!==n&&n.contains(l)||null!==(r=a.classList)&&void 0!==r&&r.contains(g)||a.isContentEditable?NodeFilter.FILTER_REJECT:NodeFilter.FILTER_ACCEPT}});try{for(var p,f=[],v=[];p=m.nextNode();)f.push(p),l.test(p.nodeValue)&&(v.push(p),l.lastIndex=0);if(v.length>0&&function(t,n){e.has(t)||e.set(t,[]);var r=e.get(t);n.forEach((function(e){var t=e.parentNode;t&&r.push({parent:t,originalHTML:t.innerHTML,originalTextContent:t.textContent})}))}(d,v),f.forEach((function(e){!function(e,t,n,r){var a=e.nodeValue,o=Array.from(a.matchAll(t));if(0===o.length)return!1;var i=document.createDocumentFragment(),c=0;o.forEach((function(e){e.index>c&&i.appendChild(document.createTextNode(a.substring(c,e.index)));var t=function(e,t){var n=document.createElement("span");return n.style.backgroundColor=t,n.className="page-highlighter-highlight",n.textContent=e,n}(e[0],n);i.appendChild(t),r.elements.push(t),c=e.index+e[0].length})),c<a.length&&i.appendChild(document.createTextNode(a.substring(c))),e.parentNode.replaceChild(i,e)}(e,l,i,u)})),u.elements.length>0){t.set(h,u);try{chrome.runtime.sendMessage({action:"highlight-added",highlight:{id:h,text:g,color:i,count:u.elements.length}})}catch(e){console.error("Failed to send highlight-added message:",e)}}}catch(e){return console.error("Error while highlighting:",e),{elements:[],error:e.message}}return u}chrome.runtime.onMessage.addListener((function(e,n,r){try{switch(e.action){case"ping":r({success:!0});break;case"highlight":o();var a=i(e.text,e.color,e.isRegex,e.isCaseSensitive);a.error?r({success:!1,error:a.error}):r({success:a.elements.length>0,count:a.elements.length});break;case"get-highlights":r({highlights:Array.from(t.values()).map((function(e){return{id:e.id,text:e.text,color:e.color}}))});break;case"remove-highlight":o(),r({success:!0});break;default:r({error:"Unknown action"})}}catch(e){console.error("Error in message handler:",e),r({error:e.message})}return!0}))})();