(()=>{"use strict";(()=>{function e(e){return e.replace(/\s+/g," ").trim()}var r=new Map,t=0;function n(e,r){var t=document.createElement("span");return t.style.backgroundColor=r,t.className="page-highlighter-highlight",t.textContent=e,t}function o(){r.forEach((function(e){e.elements.forEach((function(e){if(e&&e.parentNode){var r=e.textContent,t=document.createTextNode(r);e.parentNode.replaceChild(t,e)}}))})),r.clear(),t=0}chrome.runtime.onMessage.addListener((function(a,c,i){try{switch(a.action){case"ping":i({success:!0});break;case"highlight":o();var l=function(o,a,c,i){var l,s=++t,h=c?o:e(o);try{l=function(e,r,t){if(r)return new RegExp(e,t?"g":"gi");var n=e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");return new RegExp(n,t?"g":"gi")}(h,c,i)}catch(e){return console.error("Invalid regex pattern:",e),{elements:[],error:"Invalid regex pattern"}}var u={id:s,text:h,color:a,elements:[]},d=document.createTreeWalker(document.body,NodeFilter.SHOW_TEXT,{acceptNode:function(e){var r,t=e.parentNode;return!t||"SCRIPT"===t.nodeName||"STYLE"===t.nodeName||"NOSCRIPT"===t.nodeName||null!==(r=t.classList)&&void 0!==r&&r.contains("page-highlighter-highlight")||t.isContentEditable?NodeFilter.FILTER_REJECT:NodeFilter.FILTER_ACCEPT}});try{for(var g,m=[];g=d.nextNode();)c||(g.nodeValue=e(g.nodeValue)),m.push(g);m.forEach((function(e){!function(e,r,t,n,o){var a=e.nodeValue,c=Array.from(a.matchAll(r));if(0===c.length)return!1;var i=document.createDocumentFragment(),l=0;c.forEach((function(e){e.index>l&&i.appendChild(document.createTextNode(a.substring(l,e.index)));var r=o(e[0],t);i.appendChild(r),n.elements.push(r),l=e.index+e[0].length})),l<a.length&&i.appendChild(document.createTextNode(a.substring(l))),e.parentNode.replaceChild(i,e)}(e,l,a,u,n)})),u.elements.length>0&&r.set(s,u)}catch(e){return console.error("Error while highlighting:",e),{elements:[],error:e.message}}return u}(a.text,a.color,a.isRegex,a.isCaseSensitive);l.error?i({success:!1,error:l.error}):i({success:l.elements.length>0,count:l.elements.length});break;case"get-highlights":i({highlights:Array.from(r.values()).map((function(e){return{id:e.id,text:e.text,color:e.color}}))});break;case"remove-highlight":o(),i({success:!0});break;default:i({error:"Unknown action"})}}catch(e){console.error("Error in message handler:",e),i({error:e.message})}return!0}))})()})();